import{c as R}from"./index-D9wpEcif.js";import{r as x,c as D,q as A,Z as M,x as n,z as e,P as o,L as g,Q as k,ac as h,y as d,C as K}from"./vue-vendor-Bsazo-x0.js";import"./element-plus-CqiD73Lu.js";import"./vendor-Dr8jvgFu.js";const O={class:"space-y-4"},B={class:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"},F={class:"text-sm text-gray-500 dark:text-gray-400"},L={class:"flex items-center gap-2"},E={key:0,class:"text-xs text-gray-500 dark:text-gray-400"},P={class:"overflow-hidden rounded-2xl bg-white shadow dark:bg-gray-900"},V={class:"overflow-x-auto"},$={class:"min-w-full divide-y divide-gray-200 dark:divide-gray-800"},z={class:"bg-gray-50 dark:bg-gray-800/50"},S={class:"divide-y divide-gray-100 dark:divide-gray-800"},j={class:"whitespace-nowrap px-4 py-3 text-sm text-gray-900 dark:text-gray-100"},w={class:"px-4 py-3 font-mono text-sm text-gray-700 dark:text-gray-100"},H={class:"text-primary-600 dark:text-primary-400 px-4 py-3 text-xs font-semibold uppercase"},Q={class:"px-4 py-3 text-sm text-gray-800 dark:text-gray-200"},U={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-200"},Z={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-200"},G={class:"px-4 py-3 text-sm text-gray-800 dark:text-gray-100"},J={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-100"},W={class:"flex flex-col leading-tight"},X={key:0},Y={key:1},v={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-100"},tt={class:"px-4 py-3 text-sm"},et={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-100"},_=3e3,dt={__name:"RequestLogsView",setup(st){const b=["时间","Request ID","方法","Endpoint","用户","账户","模型","Tokens (In/Out/Total)","价格","状态","耗时"],u=x([]),f=x("0-0"),c=x(!1);let m=null;const p=a=>a==="..."?"bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200":Number(a)>=500?"bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-200":Number(a)>=400?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200":"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-200",I=(a=[])=>{const r=new Map(u.value.map(t=>[t.requestId,{...t}]));a.forEach(t=>{const l=t.requestId||t.id;if(!l)return;const s=r.get(l)||{requestId:l,statusDisplay:"...",statusClass:p("...")};t.method&&(s.method=t.method),t.endpoint&&(s.endpoint=t.endpoint),t.timestamp&&!s.timestamp&&(s.timestamp=t.timestamp),t.apiKeyName&&(s.apiKeyName=t.apiKeyName),t.apiKeyId&&(s.apiKeyId=t.apiKeyId),t.userId&&(s.userId=t.userId),t.accountId&&(s.accountId=t.accountId),t.accountName&&(s.accountName=t.accountName),t.model&&(s.model=t.model),t.phase==="start"?(s.statusDisplay="...",s.statusClass=p("...")):(t.status!==void 0&&t.status!==null&&(s.status=t.status,s.statusDisplay=t.status,s.statusClass=p(t.status)),t.durationMs!==void 0&&t.durationMs!==null&&(s.durationMs=t.durationMs),t.tokensIn!==void 0&&t.tokensIn!==null&&(s.tokensIn=t.tokensIn),t.tokensOut!==void 0&&t.tokensOut!==null&&(s.tokensOut=t.tokensOut),t.cacheCreateTokens!==void 0&&t.cacheCreateTokens!==null&&(s.cacheCreateTokens=t.cacheCreateTokens),t.cacheReadTokens!==void 0&&t.cacheReadTokens!==null&&(s.cacheReadTokens=t.cacheReadTokens),t.tokensTotal!==void 0&&t.tokensTotal!==null&&(s.tokensTotal=t.tokensTotal),t.price!==void 0&&t.price!==null&&(s.price=t.price),t.timestamp&&(s.completedAt=t.timestamp)),r.set(l,s)}),u.value=Array.from(r.values())},y=async(a=!1)=>{if(!c.value){c.value=!0;try{const r=a?"0-0":f.value,t=await R.get("/admin/request-logs",{params:{cursor:r,limit:200}});Array.isArray(t.events)&&I(t.events),t.lastId&&(f.value=t.lastId)}catch(r){console.error("Failed to load request logs:",r)}finally{c.value=!1}}},T=()=>y(),C=D(()=>[...u.value].sort((a,r)=>{const t=new Date(a.completedAt||a.timestamp||0).getTime();return new Date(r.completedAt||r.timestamp||0).getTime()-t})),N=a=>{if(!a)return"—";try{return new Date(a).toLocaleString()}catch{return a}},q=a=>{if(a==null)return"—";const r=Number(a);return Number.isFinite(r)?`$${r.toFixed(6)}`:"—"},i=a=>a??"—";return A(()=>{y(!0),m=setInterval(y,_)}),M(()=>{m&&clearInterval(m)}),(a,r)=>(d(),n("div",O,[e("div",B,[e("div",null,[r[0]||(r[0]=e("h1",{class:"text-xl font-bold text-gray-900 dark:text-gray-50"},"请求日志",-1)),e("p",F," 仅展示 API Key 请求，自动刷新（"+o(_/1e3)+"s），最新请求在最上方 ",1)]),e("div",L,[c.value?(d(),n("span",E,"同步中...")):g("",!0),e("button",{class:"bg-primary-600 hover:bg-primary-700 focus:ring-primary-500 dark:bg-primary-500 dark:hover:bg-primary-400 rounded-lg px-3 py-2 text-sm font-semibold text-white shadow focus:outline-none focus:ring-2",onClick:T}," 手动刷新 ")])]),e("div",P,[e("div",V,[e("table",$,[e("thead",z,[e("tr",null,[(d(),n(k,null,h(b,t=>e("th",{key:t,class:"px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400"},o(t),1)),64))])]),e("tbody",S,[(d(!0),n(k,null,h(C.value,t=>(d(),n("tr",{key:t.requestId,class:"hover:bg-gray-50/70 dark:hover:bg-gray-800/50"},[e("td",j,o(N(t.timestamp)),1),e("td",w,o(t.requestId),1),e("td",H,o(t.method||"—"),1),e("td",Q,o(t.endpoint),1),e("td",U,o(t.userId||"—"),1),e("td",Z,o(t.accountName||t.accountId||"—"),1),e("td",G,o(t.model||"—"),1),e("td",J,[e("div",W,[e("span",null,"In: "+o(i(t.tokensIn)),1),e("span",null,"Out: "+o(i(t.tokensOut)),1),t.cacheCreateTokens!==void 0&&t.cacheCreateTokens!==null?(d(),n("span",X," Cache+: "+o(i(t.cacheCreateTokens)),1)):g("",!0),t.cacheReadTokens!==void 0&&t.cacheReadTokens!==null?(d(),n("span",Y," Cache Hit: "+o(i(t.cacheReadTokens)),1)):g("",!0),e("span",null,"Total: "+o(i(t.tokensTotal)),1)])]),e("td",v,o(q(t.price)),1),e("td",tt,[e("span",{class:K(["inline-flex items-center rounded-full px-2 py-1 text-xs font-semibold",t.statusClass])},o(t.statusDisplay),3)]),e("td",et,o(t.durationMs?`${t.durationMs} ms`:"…"),1)]))),128))])])])])]))}};export{dt as default};
