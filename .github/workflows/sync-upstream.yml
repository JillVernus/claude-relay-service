name: Sync Upstream

on:
  workflow_dispatch:
    inputs:
      skip_feature_merge:
        description: 'Skip merging main into feature branch'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

env:
  UPSTREAM_REPO: Wei-Shaw/claude-relay-service
  FEATURE_BRANCH: feature/request-logs

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream
          git fetch origin

      - name: Sync main with upstream
        id: sync_main
        run: |
          # Save workflow file before sync
          cp .github/workflows/sync-upstream.yml /tmp/sync-upstream.yml

          git checkout main

          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind_count=$BEHIND" >> $GITHUB_OUTPUT

          if [ "$BEHIND" -eq 0 ]; then
            echo "Main is already up to date with upstream"
            echo "main_updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found $BEHIND new commits from upstream"

          if git merge --ff-only upstream/main; then
            echo "Fast-forward merge successful"
          else
            echo "Fast-forward failed, resetting to upstream"
            git reset --hard upstream/main
          fi

          # Restore workflow file
          mkdir -p .github/workflows
          cp /tmp/sync-upstream.yml .github/workflows/sync-upstream.yml
          if ! git diff --quiet .github/workflows/sync-upstream.yml; then
            git add .github/workflows/sync-upstream.yml
            git commit -m "chore: preserve sync-upstream workflow [skip ci]"
          fi

          git push origin main --force-with-lease
          echo "main_updated=true" >> $GITHUB_OUTPUT

      - name: Merge main into feature branch
        id: merge_feature
        if: steps.sync_main.outputs.main_updated == 'true' && inputs.skip_feature_merge != true
        run: |
          git checkout ${{ env.FEATURE_BRANCH }}

          if git merge main --no-edit; then
            echo "Merge successful"
            git push origin ${{ env.FEATURE_BRANCH }}
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "Merge conflicts detected"
            git merge --abort
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
          fi

      - name: Create PR for conflicts
        if: steps.merge_feature.outputs.merge_status == 'conflict'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="sync/upstream-$(date +%Y%m%d-%H%M%S)"

          git checkout -b "$BRANCH_NAME" main
          git push origin "$BRANCH_NAME"

          gh pr create \
            --base "${{ env.FEATURE_BRANCH }}" \
            --head "$BRANCH_NAME" \
            --title "ðŸ”„ Sync upstream updates (requires conflict resolution)" \
            --body "## Upstream Sync

          This PR contains updates from upstream that have merge conflicts with your feature branch.

          ### Steps to resolve:
          1. Checkout this branch locally
          2. Resolve the conflicts
          3. Commit and push
          4. Merge this PR

          \`\`\`bash
          git fetch origin
          git checkout ${{ env.FEATURE_BRANCH }}
          git merge origin/${BRANCH_NAME}
          # resolve conflicts
          git add .
          git commit
          git push
          \`\`\`

          ðŸ¤– Auto-generated by sync-upstream workflow"

      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sync_main.outputs.main_updated }}" == "true" ]; then
            echo "âœ… Main synced with upstream (${{ steps.sync_main.outputs.behind_count }} commits)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Main already up to date" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.merge_feature.outputs.merge_status }}" == "success" ]; then
            echo "âœ… Feature branch merged successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.merge_feature.outputs.merge_status }}" == "conflict" ]; then
            echo "âš ï¸ Conflicts detected - PR created for manual resolution" >> $GITHUB_STEP_SUMMARY
          fi
